<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–û–±–ª—ñ–∫ –ø–æ—Å–∏–ª–æ–∫</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box}
body{
font-family:-apple-system,BlinkMacSystemFont,sans-serif;
margin:0;
padding:12px;
background:#f2f4f7;
}
h2{text-align:center}
input,select,button{
width:100%;
padding:12px;
margin:6px 0;
border-radius:12px;
border:1px solid #ccc;
font-size:16px;
}
button{
background:#007aff;
color:white;
border:none;
}
button.delete{background:#ff3b30}
button.export{background:#34c759}
button:active{transform:scale(.97)}
.price-row{
display:flex;
gap:6px;
align-items:center;
}
.price-row input{flex:1}
.checkbox-inline{
display:flex;
align-items:center;
gap:4px;
font-size:14px;
}
.table-wrapper{
margin-top:20px;
background:white;
padding:10px;
border-radius:14px;
box-shadow:0 2px 6px rgba(0,0,0,.05);
overflow-x:auto;
}
table{
min-width:1000px;
width:100%;
border-collapse:collapse;
}
th,td{
padding:6px;
font-size:12px;
text-align:center;
border-bottom:1px solid #eee;
}
th{
background:#007aff;
color:white;
}
.summary{
font-weight:bold;
margin:8px 0;
}
h3{
cursor:pointer;
background:#e9eef5;
padding:8px;
border-radius:8px;
}
</style>
</head>
<body>

<h2>–û–±–ª—ñ–∫ –ø–æ—Å–∏–ª–æ–∫</h2>

<input id="tripName" placeholder="–ù–∞–∑–≤–∞ —Ä–µ–π—Å—É">
<button onclick="createTrip()">–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–µ–π—Å</button>

<select id="tripSelect"></select>
<button class="delete" onclick="deleteTrip()">–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ–π—Å</button>

<input id="fullName" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ —Ç–∞ –Ü–º º—è">
<input id="parcelNumber" placeholder="–ù–æ–º–µ—Ä –ø–æ—Å–∏–ª–∫–∏" inputmode="numeric">
<input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" inputmode="numeric">
<input id="city" list="citiesList" placeholder="–ú—ñ—Å—Ç–æ">
<datalist id="citiesList"></datalist>
<input id="branch" placeholder="–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏">
<input id="places" type="number" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å –º—ñ—Å—Ü—å">
<input id="volume" placeholder="–û–± º—î–º–∏ —á–µ—Ä–µ–∑ –∫–æ–º—É (12,5 8,2 3)">
<input id="weight" type="number" placeholder="–§–∞–∫—Ç–∏—á–Ω–∞ –≤–∞–≥–∞">

<div class="price-row">
<input id="price" type="number" placeholder="–¶—ñ–Ω–∞">
<label class="checkbox-inline">
<input type="checkbox" id="ourPayment"> –ù–∞—à–∞
</label>
<label class="checkbox-inline">
<input type="checkbox" id="invoice"> –†–∞—Ö—É–Ω–æ–∫
</label>
</div>

<input id="note" placeholder="–ü—Ä–∏–º—ñ—Ç–∫–∞">
<button onclick="addParcel()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>

<div id="tables"></div>

<script>

let parcels=JSON.parse(localStorage.getItem("parcels"))||[];
let trips=JSON.parse(localStorage.getItem("trips"))||[];
let clients=JSON.parse(localStorage.getItem("clients"))||{};
let userCities=JSON.parse(localStorage.getItem("userCities"))||[];
let editId=null;

const defaultCities=[
"–ö–∏—ó–≤","–•–∞—Ä–∫—ñ–≤","–û–¥–µ—Å–∞","–î–Ω—ñ–ø—Ä–æ","–õ—å–≤—ñ–≤","–ó–∞–ø–æ—Ä—ñ–∂–∂—è",
"–í—ñ–Ω–Ω–∏—Ü—è","–ü–æ–ª—Ç–∞–≤–∞","–ß–µ—Ä–Ω—ñ–≥—ñ–≤","–ß–µ—Ä–∫–∞—Å–∏","–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π",
"–ñ–∏—Ç–æ–º–∏—Ä","–°—É–º–∏","–†—ñ–≤–Ω–µ","–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫",
"–¢–µ—Ä–Ω–æ–ø—ñ–ª—å","–õ—É—Ü—å–∫","–£–∂–≥–æ—Ä–æ–¥","–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π","–ú–∏–∫–æ–ª–∞—ó–≤"
];

function autoSave(){
localStorage.setItem("parcels",JSON.stringify(parcels));
localStorage.setItem("trips",JSON.stringify(trips));
localStorage.setItem("clients",JSON.stringify(clients));
localStorage.setItem("userCities",JSON.stringify(userCities));
}

function createTrip(){
if(!tripName.value.trim())return;
if(trips.includes(tripName.value))return;
trips.push(tripName.value);
autoSave();
renderTrips();
tripName.value="";
}

function deleteTrip(){
if(!tripSelect.value)return;
if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ–π—Å?"))return;
parcels=parcels.filter(p=>p.trip!==tripSelect.value);
trips=trips.filter(t=>t!==tripSelect.value);
autoSave();
renderTrips();
}

function addParcel(){
if(!tripSelect.value)return alert("–°—Ç–≤–æ—Ä—ñ—Ç—å —Ä–µ–π—Å");

let volumes=volume.value.trim()
?volume.value.split(/[, ]+/).map(v=>Number(v)).filter(v=>!isNaN(v))
:[];

let totalVolume=volumes.reduce((s,v)=>s+v,0);

let data={
id:editId||Date.now(),
trip:tripSelect.value,
fullName:fullName.value,
number:parcelNumber.value,
phone:phone.value,
city:city.value,
branch:branch.value,
places:Number(places.value||0),
volumeList:volumes,
volume:totalVolume,
weight:Number(weight.value||0),
price:Number(price.value||0),
ourPayment:ourPayment.checked,
invoice:invoice.checked,
note:note.value
};

if(editId){
parcels=parcels.map(p=>p.id===editId?data:p);
editId=null;
}else{
parcels.push(data);
}

clients[phone.value]=fullName.value;

if(city.value && !defaultCities.includes(city.value) && !userCities.includes(city.value)){
userCities.push(city.value);
}

autoSave();
renderTables();
clearInputs();
}

function editParcel(id){
let p=parcels.find(p=>p.id===id);
if(!p)return;
editId=id;
fullName.value=p.fullName;
parcelNumber.value=p.number;
phone.value=p.phone;
city.value=p.city;
branch.value=p.branch;
places.value=p.places;
volume.value=p.volumeList.join(" ");
weight.value=p.weight;
price.value=p.price;
ourPayment.checked=p.ourPayment;
invoice.checked=p.invoice;
note.value=p.note;
window.scrollTo({top:0,behavior:"smooth"});
}

function deleteParcel(id){
parcels=parcels.filter(p=>p.id!==id);
autoSave();
renderTables();
}

function renderTrips(){
tripSelect.innerHTML="";
trips.forEach(t=>{
let o=document.createElement("option");
o.value=t;
o.textContent=t;
tripSelect.appendChild(o);
});
renderTables();
}

function toggleTrip(trip){
let el=document.getElementById("content-"+trip);
el.style.display=el.style.display==="none"?"block":"none";
}

function renderTables(){
tables.innerHTML="";
trips.forEach(trip=>{
let tripParcels=parcels.filter(p=>p.trip===trip);
if(!tripParcels.length)return;

let totalPrice=tripParcels.reduce((s,p)=>s+p.price,0);
let totalWeight=tripParcels.reduce((s,p)=>s+p.weight,0);
let totalPlaces=tripParcels.reduce((s,p)=>s+p.places,0);

let wrapper=document.createElement("div");
wrapper.className="table-wrapper";

wrapper.innerHTML=`
<h3 onclick="toggleTrip('${trip}')">
${trip} (${tripParcels.length}) ‚¨áÔ∏è
</h3>
<div id="content-${trip}">
<div class="summary">
üí∞ ${totalPrice} –≥—Ä–Ω | ‚öñÔ∏è ${totalWeight} –∫–≥ | üì¶ ${totalPlaces}
</div>
<button class="export" onclick="exportExcel('${trip}')">–ï–∫—Å–ø–æ—Ä—Ç Excel</button>
<table>
<tr>
<th>–ü–Ü–ë</th><th>–ù–æ–º–µ—Ä</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
<th>–ú—ñ—Å—Ç–æ</th><th>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è</th>
<th>–ú—ñ—Å—Ü—è</th><th>–û–± º—î–º</th>
<th>–í–∞–≥–∞</th><th>–¶—ñ–Ω–∞</th>
<th>–ù–∞—à–∞</th><th>–†–∞—Ö</th>
<th>‚úèÔ∏è</th><th>‚ùå</th>
</tr>
${tripParcels.map(p=>`
<tr>
<td>${p.fullName}</td>
<td>${p.number}</td>
<td>${p.phone}</td>
<td>${p.city}</td>
<td>${p.branch}</td>
<td>${p.places}</td>
<td>${p.volume}</td>
<td>${p.weight}</td>
<td>${p.price}</td>
<td>${p.ourPayment?"‚úì":""}</td>
<td>${p.invoice?"‚úì":""}</td>
<td><button onclick="editParcel(${p.id})">‚úèÔ∏è</button></td>
<td><button class="delete" onclick="deleteParcel(${p.id})">X</button></td>
</tr>
`).join("")}
</table>
</div>
`;
tables.appendChild(wrapper);
});
}

function exportExcel(trip){
let data=parcels.filter(p=>p.trip===trip);
if(!data.length)return alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö");

let formatted=data.map(p=>({
"–ü–Ü–ë":p.fullName,
"–ù–æ–º–µ—Ä":p.number,
"–¢–µ–ª–µ—Ñ–æ–Ω":p.phone,
"–ú—ñ—Å—Ç–æ":p.city,
"–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è":p.branch,
"–ú—ñ—Å—Ü—è":p.places,
"–û–± º—î–º":p.volume,
"–í–∞–≥–∞":p.weight,
"–¶—ñ–Ω–∞":p.price,
"–ù–∞—à–∞ –æ–ø–ª–∞—Ç–∞":p.ourPayment?"‚úì":"",
"–†–∞—Ö—É–Ω–æ–∫":p.invoice?"‚úì":"",
"–ü—Ä–∏–º—ñ—Ç–∫–∞":p.note
}));

let ws=XLSX.utils.json_to_sheet(formatted);
ws['!cols']=Object.keys(formatted[0]).map(k=>({wch:20}));
let wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,trip);
XLSX.writeFile(wb,"–†–µ–π—Å_"+trip+".xlsx");
}

phone.addEventListener("blur",function(){
if(clients[this.value])fullName.value=clients[this.value];
});

renderTrips();

</script>
</body>
</html>
