<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>–û–±–ª—ñ–∫ –ø–æ—Å–∏–ª–æ–∫</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* { box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:12px; background:#f2f4f7; }
h2 { text-align:center; margin-bottom:10px; }
input, select, button { padding:12px; margin:5px 0; font-size:16px; border-radius:12px; border:1px solid #ccc; }
input[type=number], input[type=text], input[type=tel] { width:100%; }
.button-row { display:flex; gap:5px; }
button { background:#007aff; color:white; border:none; border-radius:12px; flex:1; }
button.delete { background:#ff3b30; }
button.export { background:#34c759; margin-top:8px; }
button:active { transform:scale(0.98); }
.table-wrapper { margin-top:25px; background:white; padding:10px; border-radius:14px; box-shadow:0 2px 6px rgba(0,0,0,0.05); overflow-x:auto; }
table { min-width:1000px; width:100%; border-collapse:collapse; }
th, td { padding:6px; font-size:12px; text-align:center; border-bottom:1px solid #eee; }
th { background:#007aff; color:white; }
.summary { font-weight:bold; font-size:14px; margin:8px 0; }
.checkbox-inline { display:flex; align-items:center; gap:5px; margin:5px 0; }
.checkbox-inline input { margin:0; }
.price-row { display:flex; gap:5px; align-items:center; }
.price-row input { flex:1; }
.edit-btn { background:#ff9500; font-size:12px; padding:2px 6px; }
</style>
</head>
<body>

<h2>–û–±–ª—ñ–∫ –ø–æ—Å–∏–ª–æ–∫</h2>

<input id="tripName" placeholder="–ù–∞–∑–≤–∞ —Ä–µ–π—Å—É">
<button onclick="createTrip()">–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–µ–π—Å</button>

<select id="tripSelect"></select>
<button class="delete" onclick="deleteTrip()">–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ–π—Å</button>

<input id="fullName" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ —Ç–∞ –Ü–º º—è" type="text">
<input id="parcelNumber" placeholder="–ù–æ–º–µ—Ä –ø–æ—Å–∏–ª–∫–∏" type="text" inputmode="numeric" pattern="[0-9]*">
<input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" type="tel" inputmode="numeric">
<input id="city" list="citiesList" placeholder="–ú—ñ—Å—Ç–æ" type="text">
<datalist id="citiesList"></datalist>
<input id="branch" placeholder="–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏" type="text">
<input id="places" type="number" inputmode="numeric" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å –º—ñ—Å—Ü—å">
<input id="volume" type="number" inputmode="decimal" placeholder="–û–± º—î–º–Ω–∞ –≤–∞–≥–∞">
<input id="weight" type="number" inputmode="decimal" placeholder="–§–∞–∫—Ç–∏—á–Ω–∞ –≤–∞–≥–∞">

<div class="price-row">
  <input id="price" type="number" inputmode="decimal" placeholder="–¶—ñ–Ω–∞">
  <label class="checkbox-inline"><input type="checkbox" id="ourPayment"> –ù–∞—à–∞ –æ–ø–ª–∞—Ç–∞</label>
  <label class="checkbox-inline"><input type="checkbox" id="invoice"> –†–∞—Ö—É–Ω–æ–∫</label>
</div>

<input id="note" placeholder="–ü—Ä–∏–º—ñ—Ç–∫–∞" type="text">
<button onclick="addParcel()">–î–æ–¥–∞—Ç–∏ / –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Å–∏–ª–∫—É</button>

<div id="tables"></div>

<script>
// –î–∞–Ω—ñ
let parcels = JSON.parse(localStorage.getItem("parcels"))||[];
let trips = JSON.parse(localStorage.getItem("trips"))||[];
let clients = JSON.parse(localStorage.getItem("clients"))||{};
let userCities = JSON.parse(localStorage.getItem("userCities"))||[];
let editId = null;

// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –º—ñ—Å—Ç–∞
const cities = ["–ö–∏—ó–≤","–•–∞—Ä–∫—ñ–≤","–û–¥–µ—Å–∞","–î–Ω—ñ–ø—Ä–æ","–õ—å–≤—ñ–≤","–ó–∞–ø–æ—Ä—ñ–∂–∂—è","–í—ñ–Ω–Ω–∏—Ü—è","–ü–æ–ª—Ç–∞–≤–∞","–ß–µ—Ä–Ω—ñ–≥—ñ–≤","–ß–µ—Ä–∫–∞—Å–∏","–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π","–ñ–∏—Ç–æ–º–∏—Ä","–°—É–º–∏","–†—ñ–≤–Ω–µ","–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫","–¢–µ—Ä–Ω–æ–ø—ñ–ª—å","–õ—É—Ü—å–∫","–£–∂–≥–æ—Ä–æ–¥","–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π","–ú–∏–∫–æ–ª–∞—ó–≤"];
const citiesList = document.getElementById("citiesList");
const city = document.getElementById("city");

// –§—ñ–ª—å—Ç—Ä –º—ñ—Å—Ç + –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ
function filterCities(query){
    citiesList.innerHTML = "";
    const allCities = [...cities,...userCities];
    allCities.filter(c=>c.toLowerCase().includes(query.toLowerCase()))
        .forEach(c=>{
            const opt = document.createElement("option");
            opt.value = c;
            citiesList.appendChild(opt);
        });
}
city.addEventListener("input",()=>filterCities(city.value));

// –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
function autoSave(){
    localStorage.setItem("parcels", JSON.stringify(parcels));
    localStorage.setItem("trips", JSON.stringify(trips));
    localStorage.setItem("clients", JSON.stringify(clients));
    localStorage.setItem("userCities", JSON.stringify(userCities));
}

// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–π—Å—É
const tripSelect = document.getElementById("tripSelect");
function createTrip(){
    const name = tripName.value.trim();
    if(!name || trips.includes(name)) return;
    trips.push(name);
    autoSave();
    renderTrips();
    tripName.value="";
}
function deleteTrip(){
    const trip = tripSelect.value;
    if(!trip) return;
    if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ–π—Å —ñ –≤—Å—ñ –ø–æ—Å–∏–ª–∫–∏?")) return;
    trips = trips.filter(t=>t!==trip);
    parcels = parcels.filter(p=>p.trip!==trip);
    autoSave();
    renderTrips();
}

// –î–æ–¥–∞—Ç–∏ –∞–±–æ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∫—É
function addParcel(){
    const trip = tripSelect.value;
    if(!trip) return alert("–°—Ç–≤–æ—Ä—ñ—Ç—å —Ä–µ–π—Å!");
    const parcel = {
        id: editId || Date.now(),
        trip,
        fullName: fullName.value,
        number: parcelNumber.value,
        phone: phone.value,
        city: city.value,
        branch: branch.value,
        places: Number(places.value||0),
        volume: Number(volume.value||0),
        weight: Number(weight.value||0),
        price: Number(price.value||0),
        ourPayment: document.getElementById("ourPayment").checked,
        invoice: document.getElementById("invoice").checked,
        note: note.value
    };

    clients[phone.value]=fullName.value;

    // –î–æ–¥–∞—î–º–æ –º—ñ—Å—Ç–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–µ
    if(city.value && !userCities.includes(city.value) && !cities.includes(city.value)){
        userCities.push(city.value);
    }

    if(editId){
        parcels = parcels.map(p=>p.id===editId ? parcel : p);
        editId=null;
    } else {
        parcels.push(parcel);
    }

    autoSave();
    renderTables();
    clearInputs();
}

function clearInputs(){
    document.querySelectorAll("input:not(#tripName)").forEach(i=>i.value="");
    document.getElementById("ourPayment").checked=false;
    document.getElementById("invoice").checked=false;
    editId=null;
}

// –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–æ—Å–∏–ª–∫–∏
function editParcel(id){
    const p = parcels.find(p=>p.id===id);
    if(!p) return;
    fullName.value=p.fullName;
    parcelNumber.value=p.number;
    phone.value=p.phone;
    city.value=p.city;
    branch.value=p.branch;
    places.value=p.places;
    volume.value=p.volume;
    weight.value=p.weight;
    price.value=p.price;
    document.getElementById("ourPayment").checked=p.ourPayment;
    document.getElementById("invoice").checked=p.invoice;
    note.value=p.note;
    editId=id;
}

// –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å–∏–ª–∫—É
function deleteParcel(id){
    parcels = parcels.filter(p=>p.id!==id);
    autoSave();
    renderTables();
}

// –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ —Ä–µ–π—Å–∏
function renderTrips(){
    tripSelect.innerHTML="";
    trips.forEach(trip=>{
        let option=document.createElement("option");
        option.value=trip;
        option.textContent=trip;
        tripSelect.appendChild(option);
    });
    renderTables();
}

// –¢–∞–±–ª–∏—Ü—ñ
const tables = document.getElementById("tables");
function renderTables(){
    tables.innerHTML="";
    trips.forEach(trip=>{
        const tripParcels = parcels.filter(p=>p.trip===trip);
        if(tripParcels.length===0) return;
        const totalPrice = tripParcels.reduce((s,p)=>s+p.price,0);
        const totalWeight = tripParcels.reduce((s,p)=>s+p.weight,0);
        const totalPlaces = tripParcels.reduce((s,p)=>s+p.places,0);

        let wrapper=document.createElement("div");
        wrapper.className="table-wrapper";

        wrapper.innerHTML=`
            <h3>${trip}</h3>
            <div class="summary">
                üí∞ –°—É–º–∞: ${totalPrice} –≥—Ä–Ω |
                ‚öñÔ∏è –í–∞–≥–∞: ${totalWeight} –∫–≥ |
                üì¶ –ú—ñ—Å—Ü—è: ${totalPlaces}
            </div>
            <button class="export" onclick="exportExcel('${trip}')">–ï–∫—Å–ø–æ—Ä—Ç Excel</button>
            <table>
            <tr>
                <th>–ü–Ü–ë</th><th>–ù–æ–º–µ—Ä</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ú—ñ—Å—Ç–æ</th><th>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è</th>
                <th>–ú—ñ—Å—Ü—è</th><th>–û–± º—î–º</th><th>–í–∞–≥–∞</th><th>–¶—ñ–Ω–∞</th><th>–ù–∞—à–∞ –æ–ø–ª–∞—Ç–∞</th><th>–†–∞—Ö—É–Ω–æ–∫</th><th>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</th><th>‚ùå</th>
            </tr>
            ${tripParcels.map(p=>`
                <tr>
                    <td>${p.fullName}</td>
                    <td>${p.number}</td>
                    <td>${p.phone}</td>
                    <td>${p.city}</td>
                    <td>${p.branch}</td>
                    <td>${p.places}</td>
                    <td>${p.volume}</td>
                    <td>${p.weight}</td>
                    <td>${p.price}</td>
                    <td>${p.ourPayment ? "‚úì" : ""}</td>
                    <td>${p.invoice ? "‚úì" : ""}</td>
                    <td><button class="edit-btn" onclick="editParcel(${p.id})">‚úé</button></td>
                    <td><button class="delete" onclick="deleteParcel(${p.id})">X</button></td>
                </tr>
            `).join("")}
            </table>
        `;
        tables.appendChild(wrapper);
    });
}

// –ï–∫—Å–ø–æ—Ä—Ç Excel —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é
function exportExcel(trip){
    const tripParcels = parcels.filter(p=>p.trip===trip);
    if(!tripParcels.length) return alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É!");
    const headersMap = {fullName:"–ü–Ü–ë", number:"–ù–æ–º–µ—Ä", phone:"–¢–µ–ª–µ—Ñ–æ–Ω", city:"–ú—ñ—Å—Ç–æ", branch:"–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è", places:"–ú—ñ—Å—Ü—è", volume:"–û–± º—î–º", weight:"–í–∞–≥–∞", price:"–¶—ñ–Ω–∞", ourPayment:"–ù–∞—à–∞ –æ–ø–ª–∞—Ç–∞", invoice:"–†–∞—Ö—É–Ω–æ–∫", note:"–ü—Ä–∏–º—ñ—Ç–∫–∞"};
    const data = tripParcels.map(p=>{
        let obj={};
        for(let k in headersMap) obj[headersMap[k]] = p[k] || '';
        if(p.ourPayment) obj["–ù–∞—à–∞ –æ–ø–ª–∞—Ç–∞"]="‚úì";
        if(p.invoice) obj["–†–∞—Ö—É–Ω–æ–∫"]="‚úì";
        return obj;
    });
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = Object.keys(data[0]).map(k=>({wch:Math.max(...data.map(r=>String(r[k]).length),k.length)+5}));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, trip);
    XLSX.writeFile(wb, `–†–µ–π—Å_${trip}.xlsx`);
}

// –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
phone.addEventListener("blur", function(){
    if(clients[this.value]) fullName.value = clients[this.value];
});

// Enter –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –º—ñ–∂ –ø–æ–ª—è–º–∏
const fields = ["fullName","parcelNumber","phone","city","branch","places","volume","weight","price","note"];
fields.forEach((id,index)=>{
    document.getElementById(id).addEventListener("keydown", function(e){
        if(e.key==="Enter"){
            e.preventDefault();
            if(index<fields.length-1) document.getElementById(fields[index+1]).focus();
            else addParcel();
        }
    });
});

renderTrips();
</script>
</body>
</html>
