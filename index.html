<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Облік посилок</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box}
body{
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    margin:0;
    padding:14px;
    background:#f2f4f7;
}
h2{text-align:center;margin-bottom:12px}

input,select,button{
    width:100%;
    padding:12px;
    margin:6px 0;
    font-size:16px;
    border-radius:12px;
    border:1px solid #ccc;
}

button{
    background:#007aff;
    color:white;
    border:none;
    font-weight:600;
}

button.delete{background:#ff3b30}
button.edit{background:#ff9500}
button.export{background:#34c759;margin-top:10px}

.price-row{
    display:flex;
    gap:6px;
    align-items:center;
}
.price-row input{flex:1}

.checkbox-inline{
    display:flex;
    align-items:center;
    gap:4px;
    font-size:14px;
}

.table-wrapper{
    margin-top:24px;
    background:white;
    padding:12px;
    border-radius:16px;
    box-shadow:0 2px 8px rgba(0,0,0,0.06);
    overflow-x:auto;
}

table{
    min-width:1100px;
    width:100%;
    border-collapse:collapse;
}

th,td{
    padding:6px;
    font-size:12px;
    text-align:center;
    border-bottom:1px solid #eee;
}

th{
    background:#007aff;
    color:white;
}

.summary{
    font-weight:bold;
    margin:8px 0;
}
</style>
</head>
<body>

<h2>Облік посилок</h2>

<input id="tripName" placeholder="Назва рейсу">
<button onclick="createTrip()">Створити рейс</button>

<select id="tripSelect"></select>
<button class="delete" onclick="deleteTrip()">Видалити рейс</button>

<input id="fullName" placeholder="Прізвище та Імʼя">
<input id="parcelNumber" placeholder="Номер посилки" inputmode="numeric">
<input id="phone" placeholder="Телефон" type="tel" inputmode="numeric">
<input id="city" list="citiesList" placeholder="Місто">
<datalist id="citiesList"></datalist>
<input id="branch" placeholder="Відділення Нової Пошти">
<input id="places" type="number" inputmode="numeric" placeholder="Кількість місць">
<input id="volume" placeholder="Обʼєми (через пробіл або кому)">
<input id="weight" type="number" inputmode="decimal" placeholder="Фактична вага">

<div class="price-row">
    <input id="price" type="number" inputmode="decimal" placeholder="Ціна">
    <label class="checkbox-inline">
        <input type="checkbox" id="ourPayment"> Наша
    </label>
    <label class="checkbox-inline">
        <input type="checkbox" id="invoice"> Рах.
    </label>
</div>

<input id="note" placeholder="Примітка">
<button onclick="addParcel()">Додати / Зберегти</button>

<div id="tables"></div>

<script>

// =======================
// ДАНІ
// =======================

let parcels = JSON.parse(localStorage.getItem("parcels"))||[];
let trips = JSON.parse(localStorage.getItem("trips"))||[];
let clients = JSON.parse(localStorage.getItem("clients"))||{};
let userCities = JSON.parse(localStorage.getItem("userCities"))||[];
let editId=null;

// =======================
// МІСТА
// =======================

const baseCities=[
"Київ","Харків","Одеса","Дніпро","Львів","Запоріжжя",
"Вінниця","Полтава","Чернігів","Черкаси","Хмельницький",
"Житомир","Суми","Рівне","Івано-Франківськ",
"Тернопіль","Луцьк","Ужгород","Кропивницький","Миколаїв"
];

const cityInput=document.getElementById("city");
const citiesList=document.getElementById("citiesList");

function filterCities(q){
    citiesList.innerHTML="";
    [...baseCities,...userCities]
    .filter(c=>c.toLowerCase().includes(q.toLowerCase()))
    .forEach(c=>{
        const o=document.createElement("option");
        o.value=c;
        citiesList.appendChild(o);
    });
}
cityInput.addEventListener("input",()=>filterCities(cityInput.value));

// =======================
// AUTOSAVE
// =======================

function save(){
    localStorage.setItem("parcels",JSON.stringify(parcels));
    localStorage.setItem("trips",JSON.stringify(trips));
    localStorage.setItem("clients",JSON.stringify(clients));
    localStorage.setItem("userCities",JSON.stringify(userCities));
}

// =======================
// РЕЙСИ
// =======================

const tripSelect=document.getElementById("tripSelect");

function createTrip(){
    const name=tripName.value.trim();
    if(!name||trips.includes(name))return;
    trips.push(name);
    save();
    renderTrips();
    tripName.value="";
}

function deleteTrip(){
    const t=tripSelect.value;
    if(!t)return;
    if(!confirm("Видалити рейс і всі посилки?"))return;
    trips=trips.filter(x=>x!==t);
    parcels=parcels.filter(p=>p.trip!==t);
    save();
    renderTrips();
}

function renderTrips(){
    tripSelect.innerHTML="";
    trips.forEach(t=>{
        const o=document.createElement("option");
        o.value=t;
        o.textContent=t;
        tripSelect.appendChild(o);
    });
    renderTables();
}

// =======================
// ДОДАТИ / РЕДАГУВАТИ
// =======================

function addParcel(){

    const trip=tripSelect.value;
    if(!trip)return alert("Створіть рейс");

    const volumes=volume.value.trim()
        ? volume.value.split(/[, ]+/)
            .map(v=>Number(v.replace(",",".")))
            .filter(v=>!isNaN(v))
        : [];

    const totalVolume=volumes.reduce((s,v)=>s+v,0);

    const data={
        id:editId||Date.now(),
        trip,
        fullName:fullName.value,
        number:parcelNumber.value,
        phone:phone.value,
        city:city.value,
        branch:branch.value,
        places:Number(places.value||0),
        volumeList:volumes,
        volume:totalVolume,
        weight:Number(weight.value||0),
        price:Number(price.value||0),
        ourPayment:ourPayment.checked,
        invoice:invoice.checked,
        note:note.value
    };

    if(editId){
        parcels=parcels.map(p=>p.id===editId?data:p);
        editId=null;
    }else{
        parcels.push(data);
    }

    clients[phone.value]=fullName.value;

    if(city.value&&!baseCities.includes(city.value)&&!userCities.includes(city.value)){
        userCities.push(city.value);
    }

    save();
    renderTables();
    clearInputs();
}

function editParcel(id){
    const p=parcels.find(p=>p.id===id);
    if(!p)return;
    editId=id;

    fullName.value=p.fullName;
    parcelNumber.value=p.number;
    phone.value=p.phone;
    city.value=p.city;
    branch.value=p.branch;
    places.value=p.places;
    volume.value=p.volumeList? p.volumeList.join(" "):p.volume;
    weight.value=p.weight;
    price.value=p.price;
    ourPayment.checked=p.ourPayment;
    invoice.checked=p.invoice;
    note.value=p.note;

    window.scrollTo({top:0,behavior:"smooth"});
}

function deleteParcel(id){
    parcels=parcels.filter(p=>p.id!==id);
    save();
    renderTables();
}

function clearInputs(){
    document.querySelectorAll("input:not(#tripName)").forEach(i=>i.value="");
    ourPayment.checked=false;
    invoice.checked=false;
}

// =======================
// ТАБЛИЦІ
// =======================

const tables=document.getElementById("tables");

function toggleTrip(t){
    const el=document.getElementById("block-"+t);
    el.style.display=el.style.display==="none"?"block":"none";
}

function renderTables(){
    tables.innerHTML="";

    trips.forEach(t=>{
        const list=parcels.filter(p=>p.trip===t);
        if(!list.length)return;

        const sum=list.reduce((s,p)=>s+p.price,0);

        const wrap=document.createElement("div");
        wrap.className="table-wrapper";

        wrap.innerHTML=`
        <h3 onclick="toggleTrip('${t}')">${t} (${list.length})</h3>
        <div id="block-${t}">
        <div class="summary">Сума: ${sum} грн</div>
        <button class="export" onclick="exportExcel('${t}')">Експорт Excel</button>
        <table>
        <tr>
        <th>ПІБ</th><th>Номер</th><th>Телефон</th>
        <th>Місто</th><th>Відділення</th>
        <th>Місця</th><th>Обʼєм</th>
        <th>Вага</th><th>Ціна</th>
        <th>Наша</th><th>Рах.</th>
        <th>✏️</th><th>❌</th>
        </tr>
        ${list.map(p=>`
        <tr>
        <td>${p.fullName}</td>
        <td>${p.number}</td>
        <td>${p.phone}</td>
        <td>${p.city}</td>
        <td>${p.branch}</td>
        <td>${p.places}</td>
        <td>${p.volume}</td>
        <td>${p.weight}</td>
        <td>${p.price}</td>
        <td>${p.ourPayment?"✓":""}</td>
        <td>${p.invoice?"✓":""}</td>
        <td><button class="edit" onclick="editParcel(${p.id})">✏️</button></td>
        <td><button class="delete" onclick="deleteParcel(${p.id})">X</button></td>
        </tr>
        `).join("")}
        </table>
        </div>
        `;
        tables.appendChild(wrap);
    });
}

// =======================
// EXCEL
// =======================

function exportExcel(trip){
    const list=parcels.filter(p=>p.trip===trip);
    if(!list.length)return;

    const data=list.map(p=>({
        "ПІБ":p.fullName,
        "Номер":p.number,
        "Телефон":p.phone,
        "Місто":p.city,
        "Відділення":p.branch,
        "Місця":p.places,
        "Обʼєм":p.volume,
        "Вага":p.weight,
        "Ціна":p.price,
        "Наша оплата":p.ourPayment?"✓":"",
        "Рахунок":p.invoice?"✓":"",
        "Примітка":p.note
    }));

    const ws=XLSX.utils.json_to_sheet(data);
    ws['!cols']=Object.keys(data[0]).map(k=>({wch:20}));
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,trip);
    XLSX.writeFile(wb,`Рейс_${trip}.xlsx`);
}

// =======================

renderTrips();

</script>
</body>
</html>
